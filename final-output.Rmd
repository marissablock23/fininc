---
title: "Visualizing Financial Inclusion"
author: "Marissa Block"
date: "1/27/2019"
output:
  html_document:    
    code_folding: show
---


```{r, echo = FALSE, results = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(here)
library(treemapify)
library(RColorBrewer)
library(haven)
library(readxl)
library(sf)
library(tmap)


findex <- read_xlsx("data/global_findex.xlsx", sheet = "Data",
                    na = "")

  # Rename first columns
  findex <- rename(findex, year = "X__1", cntry.code = "X__2", country = "X__3",
                 region = "X__4", inc.grp = "X__5")


imf <- read_dta("data/imf_fas.dta")
head(imf$iso3)
imf <- rename(imf, cntry.code = "iso3")

class <- read_xls("data/wb_class.xls", sheet = "List of economies")
head(class)
class <- class %>%
  select(X__2, X__3, X__5, X__6)

  # Make first row column names
  class <- class[-c(1:3), ]
  class <- class[-2, ]
  colnames(class) = class[1,]
  class = class[-1,]
  head(class)

  class <- rename(class, inc.grp = "Income group", country = "Economy", cntry.code = "Code")

  # Drop last 56 rows
  tail(class, n = 60)
  class <- head(class, -56)
  tail(class)
  
# Merge IMF + income group and region variables
imf <- left_join(imf, class, by = "cntry.code")

# Check for NAs
imf %>%
  filter(is.na(inc.grp)) %>%
  group_by(economy) %>%
  summarize(n = n_distinct(economy))

# Change income group for Kosovo
imf$inc.grp[imf$economy=="Kosovo, Republic of"] <- "Lower middle income"

# Anguilla and Montserrat are still NA, so remove from data
imf <- imf %>%
  filter(!is.na(inc.grp))

imf$Region <- as.factor(imf$Region)
class(imf$Region)
imf$Region <- relevel(imf$Region, "Sub-Saharan Africa")


finac.k <- read_dta("data/fin_access16_kenya.dta")
  
  # Create dummy variables
  finac.k$e4_1[finac.k$e4_1==2] <- 0
  finac.k$e4_3[finac.k$e4_3==2] <- 0
  finac.k$e4_4[finac.k$e4_4==2] <- 0
  finac.k$e4_5[finac.k$e4_5==2] <- 0
  finac.k$e4_7[finac.k$e4_7==2] <- 0
  finac.k$e4_9[finac.k$e4_9==2] <- 0
  
  finac.k$e4_1 <- as.numeric(finac.k$e4_1)

```


# Financial Access Survey, IMF
Technology has been instrumental in improving access to finance, namely mobile money and digital payments. East Africa, and Kenya in particular, have been at the forefront of mobile money. Mobile money allows for easy and safe transfers of resources among households and individuals and has significantly reduced transaction costs.
```{r, warning = FALSE}
imf %>%
  filter(!is.na(i_mob_transactions_value_GDP), year>2011) %>%
  group_by(Region, year) %>%
  summarize(mean = mean(i_mob_transactions_value_GDP, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = mean, color = Region)) +
  geom_line(size = 0.5) +
  labs(
    title = "Mobile money useage has grown significantly in Sub-Saharan Africa",
    subtitle = "Measured as average value of mobile money transactions (% of GDP)",
    caption = "Source: IMF Financial Access Survey",
    x = "Year",
    y = "Percent of GDP"
  ) +
  scale_x_continuous(breaks = c(2012, 2013, 2014, 2015, 2016, 2017)) +
  scale_color_brewer(palette = "Dark2") +
  geom_point()
ggsave(filename = "Graphs/mm_line.pdf", width = 8, height = 5)

```

# The Global Findex
## Mobile Money in Africa

```{r, warning = FALSE, fig.width = 10, fig.height = 7}
findex %>%
  filter(year == 2017, region=="Sub-Saharan Africa (excluding high income)") %>%
  select(country, mobileaccount.t.d.1, mobileaccount.t.d.2) %>%
  filter(!is.na(mobileaccount.t.d.1)) %>%
  arrange(mobileaccount.t.d.2) %>%
  mutate(country = factor(country, country), mobileaccount.t.d.1 = mobileaccount.t.d.1*100, 
         mobileaccount.t.d.2 = mobileaccount.t.d.2*100) %>%
  ggplot() +
  geom_segment(aes(x=country, xend = country, y = mobileaccount.t.d.2,
                   yend = mobileaccount.t.d.1), color = "black") +
  geom_point(aes(x = country, y = mobileaccount.t.d.2), color = "pink", size = 2) +
  geom_point(aes(x = country, y = mobileaccount.t.d.1), color = "blue", size = 2) +
  geom_text(aes(x = "Kenya", y = 67), label = "Female", size = 4, hjust = 0, nudge_y = -3) +
  geom_text(aes(x = "Kenya", y = 78), label = "Male", size = 4, hjust = 0) +
  coord_flip() +
  labs(
    subtitle = "Gender Differences in Mobile Money Access",
    title = "While Africa leads the way in mobile money access, in almost all countries, \n a higher proportion of males have mobile money accounts",
    caption = "Note: Excludes South Sudan and Central Africa Republic, for which there is no data.
    Source: Global Findex, 2017",
    y = "% of respondents with mobile money accounts (Age +15)",
    x = NULL
  ) +
  scale_y_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80))
ggsave(filename = "Graphs/mm_dotplot.pdf", width = 10, height = 7)

```

## Financial Access Survey

The following charts utilize the 2015-16 Financial Access Survey from Kenya.

Access to finance for entreprenurs is a key ingredient to economic growth. When small-to-medium enterprises, which are characteristic of Kenya, can access financial services, these business can save, invest, and ultimately grow. Yet, surprisingly, few business owners use these services.
```{r, warning = FALSE}
finac.k %>%
  filter(!is.na(l11_1)) %>%
  group_by(l11_1) %>%
  mutate(bank = "Account at a bank") %>%
  ggplot(aes(x = as.factor(bank), fill = as.factor(l11_1))) +
  geom_bar(position = "dodge", alpha = 0.8) +
  scale_fill_brewer(palette = "Oranges", name = NULL, labels = c("Currently use", "Used to use", "Never used")) +
  labs(
    title = "An overwhelming majority of Kenyan business-owners have never used a bank account",
    subtitle = "At least for business purposes",
    caption = "Source: Financial Acces Survey, 2015-2016, Kenya",
    x = NULL
  )
ggsave(filename = "Graphs/bar2.pdf", width = 8, height = 5)
```

Rather than taking out loans, Kenyan business owners tend to utilize their own personal savings to start their business. This could be a result of a number of issues, including a high interest rates or the inability of the financial sector to appropriately access risk.
```{r, warning = FALSE}
finac.k %>%
  filter(l5_1!="NA", l5_1<995) %>%
  mutate(type = factor(l5_1, labels = c("Commercial bank loan", "Microfinance loan",
                                        "SACCO loan", "Money lender", "Chama (Savings group)", 
                                        "Loan from family/friends", "Gift from family/friends", "Income from another business", "Sale of assets", 
                                        "Own savings", "Inherited", "Government fund", "Other", "Don't know", "Mobile" ))) %>%
  group_by(type, gender_of_respondent) %>%
  summarize(n = n()) %>%
ggplot(aes(area = n, fill = as.factor(gender_of_respondent), label = as.character(type), subgroup = as.factor(gender_of_respondent))) +
  geom_treemap(fill = "black") +
  geom_treemap(aes(alpha = n)) +
  geom_treemap_subgroup_border(color = "white") +
  geom_treemap_text(aes(label = type),
                        place = "center",
                        grow = F,
                        color = "white",
                        min.size = 1,
                        reflow = TRUE,
                        ) +
  scale_fill_discrete() +
  theme(legend.position = "none") +
  labs(title = "A majority of business owners user their own savings as start-up capital \n rather than loans",
       subtitle = "Female                                                                                                                              Male",
       caption = "Source: Financial Access Survey, 2015-2016, Kenya"
  )
ggsave(filename = "Graphs/treemap.pdf", width = 8, height = 5)
```

Looking beyond business owners, Kenyans utilize all sorts of financial services. Although many business-owners do not use bank accounts for business purposes, most individuals living in urban areas do use bank accounts. However, the difference in access between urban males and females is significantly different, as is the difference between rural males and females.
```{r, warning = FALSE}

finac.k %>%
  group_by(cluster_type, gender_of_respondent) %>%
  summarize(bank = mean(e4_1, na.rm = TRUE)*100,
            sacco = mean(e4_3, na.rm = TRUE)*100,
            micro = mean(e4_4, na.rm = TRUE)*100,
            savings = mean(e4_5, na.rm = TRUE)*100,
            loans = mean(e4_7, na.rm = TRUE)*100,
            insurance = mean(e4_9, na.rm = TRUE)*100) %>%
  gather("bank", "sacco", "micro", "savings", "loans", "insurance", key = "product", value = "proportion") %>%
  unite(area_sex, cluster_type, gender_of_respondent) %>%
  mutate(area_sex = factor(area_sex, levels = c("1_1", "1_2", "2_1", "2_2"),
                           labels = c("Rural male", "Rural female", "Urban male", "Urban female"))) %>%
  ggplot(aes(x = product, y = area_sex, fill = proportion)) +
  geom_tile(color = "black", size = 0.25) +
  geom_text(aes(label = paste0(round(proportion,1), "%"))) +
  scale_fill_gradient2(name = "Proportion") +
  labs(
    title = "Most Kenyans utilize savings accounts, regardless of sex or location",
    subtitle = "Note: The figures in the tiles represent the proportion of individuals with particular financial products by sex and area",
    caption = "Note: SACCO stands for Savings and Credit Cooperatives Societies \n Source: Financial Access Survey, Kenya",
    y = NULL,
    x = NULL
  )
ggsave(filename = "Graphs/heatmap.pdf", width = 8, height = 5)
```

